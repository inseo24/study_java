* 이 글은 백기선님의 더 자바, 코드를 조작하는 다양한 방법이라는 강의를 듣고 정리한 내용입니다. 

## 코드 커버리지는 어떻게 측정할까?

코드 커버리지: 테스트 코드가 해당 코드의 얼마만큼을 커버하는지. 그런 툴 중에 하나인 JaCoCo를 써보자.

- https://www.eclemma.org/jacoco/trunk/doc/index.html
- http://www.semdesigns.com/Company/Publications/TestCoverage.pdf

    
    
maven pom.xml에 플러그인을 추가함

```java
<plugin>  
     <groupId>org.jacoco</groupId>  
     <artifactId>jacoco-maven-plugin</artifactId>  
     <version>0.8.4</version>  
     <executions>  
         <execution>  
             <goals>  
                 <goal>prepare-agent</goal>  
             </goals>  
         </execution>  
         <execution>  
             <id>report</id>  
             <phase>prepare-package</phase>  
             <goals>  
                 <goal>report</goal>  
             </goals>  
         </execution>  
     </executions>  
</plugin>
```

   

메이븐 빌드

```java
mvn   clean   verif
```

   

커버리지 만족 못할 시 빌드 실패하도록 설정할 수도 있음

```java
<execution>  
             <id>jacoco-check</id>  
             <goals>  
                 <goal>check</goal>  
             </goals>  
             <configuration>  
                 <rules>  
                     <rule>  
                         <element>PACKAGE</element>  
                         <limits>  
                             <limit>  
                                 <counter>LINE</counter>  
                                 <value>COVEREDRATIO</value>  
                                 <minimum>0.50</minimum>  // 50% 통과해야 빌드 성공
                             </limit>  
                         </limits>  
                     </rule>  
                 </rules>  
             </configuration>  
         </execution>
```
   

***이런 툴은 어떻게 만들 수 있었을까?***
   
바이트 코드를 읽어서 바이트 코드에서 코드 커버리지를 체크해야하는 부분 개수를 세고,

코드가 실행이 될 때 그 중 몇개를 지나갔는지 어딜 지나가지 않았는지 계산을 하고 비교를 함. 

지나가지 않은 부분도 체크해줌. 

결국 **바이트 코드 조작**과 관련이 있음
   

## 모자에서 토끼를 꺼내는 마술

Moja.java

```java
public   class   Moja   {
		public   String   pullOut()   {
				return   "";
		}
}
```

Masulsa.java

```java
public   class   Masulsa   {
		public   static   void   main(String[]   args)   {
				System.out.println(new   Moja().pullOut());
		}
}
```

바이트코드 조작 라이브러리

● ASM:    [https://asm.ow2.io/](https://asm.ow2.io/) 

- 가장 오래됨, 비지터, 어댑터 패턴을 잘 알아야 쓸 수 있음!

● Javassist:    [https://www.javassist.org/](https://www.javassist.org/) 

● ByteBuddy:    [https://bytebuddy.net/#/](https://bytebuddy.net/#/) 

- 추천함

   
           
```java
public   class   Masulsa   {
		public   static   void   main(String[]   args)   {
			try{	
					new ByteBuddy().redefine(Moja.class)
							.method(named("pullOut)).intercept(FixedValue.value("Rabbit!"))
							.make().saveIn(new File("/Users/keesun/workspace/classloadersample/target/classes/"));
				} catch (IOException e) {
						e.printStackTrace();
				}

				//	System.out.println(new   Moja().pullOut());

		}
}
```